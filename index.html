<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChipMate Club - Interactive Attendance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        table {
            width: 100%;
            min-width: 800px;
        }
        th, td {
            white-space: nowrap;
            padding: 12px 16px;
        }
        .status-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .status-btn.editable {
             cursor: pointer;
        }
        .status-p {
            background-color: #dcfce7;
            color: #166534;
            border-color: #22c55e;
        }
        .status-a {
            background-color: #fee2e2;
            color: #991b1b;
            border-color: #ef4444;
        }
        .status-empty {
             background-color: #e2e8f0;
             color: #475569;
        }
        .status-empty.editable:hover {
            background-color: #cbd5e1;
        }
        .delete-date-btn {
            background: none; border: none; cursor: pointer;
            margin-left: 8px; font-size: 1rem; color: #94a3b8;
            transition: color 0.2s ease;
        }
        .delete-date-btn:hover { color: #ef4444; }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <div class="bg-white p-6 rounded-2xl shadow-md mb-6 border border-slate-200">
            <h1 class="text-3xl font-bold text-slate-900">ChipMate Club</h1>
            <p class="text-slate-600 mt-1">Department: SASET</p>
            <p class="text-slate-500 text-sm">Semester: 3</p>
        </div>

        <!-- Controls -->
        <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
            <h2 class="text-xl font-semibold text-slate-700">Attendance Sheet</h2>
            <div id="controlsContainer" class="flex items-center gap-2">
                 <button id="loginBtn" class="bg-blue-600 text-white font-semibold px-5 py-2.5 rounded-lg shadow-sm hover:bg-blue-700 disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>Loading...</button>
                <div id="adminControls" class="flex items-center gap-2" style="display: none;">
                    <button id="logoutBtn" class="bg-gray-500 text-white font-semibold px-5 py-2.5 rounded-lg shadow-sm hover:bg-gray-600">Logout</button>
                    <button id="changePasswordBtn" class="bg-yellow-500 text-white font-semibold px-5 py-2.5 rounded-lg shadow-sm hover:bg-yellow-600">Change Password</button>
                    <button id="downloadBtn" class="bg-green-600 text-white font-semibold px-5 py-2.5 rounded-lg shadow-sm hover:bg-green-700">Download CSV</button>
                    <button id="addDateBtn" class="bg-indigo-600 text-white font-semibold px-5 py-2.5 rounded-lg shadow-sm hover:bg-indigo-700">Add Date</button>
                </div>
            </div>
        </div>
        
        <div id="tableWrapper" class="table-container bg-white rounded-2xl shadow-md border border-slate-200">
            <table class="min-w-full divide-y divide-slate-200">
                <thead id="tableHeader" class="bg-slate-50"></thead>
                <tbody id="tableBody" class="divide-y divide-slate-200"></tbody>
            </table>
        </div>
    </div>

    <!-- Modals -->
    <div id="dateModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Add New Date</h3>
            <input type="date" id="dateInput" class="w-full p-2 border border-slate-300 rounded-lg">
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancelDateBtn" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200">Cancel</button>
                <button id="saveDateBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Add Date</button>
            </div>
        </div>
    </div>
    
    <div id="loginModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Admin Login</h3>
            <label for="passwordInput" class="block text-sm font-medium text-slate-700">Password:</label>
            <input type="password" id="passwordInput" class="mt-1 w-full p-2 border border-slate-300 rounded-lg">
            <p id="loginError" class="text-red-500 text-sm mt-2 hidden">Incorrect password.</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancelLoginBtn" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200">Cancel</button>
                <button id="submitLoginBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Login</button>
            </div>
        </div>
    </div>

    <div id="passwordChangeModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Change Admin Password</h3>
            <div class="space-y-4">
                <div>
                    <label for="currentPasswordInput" class="block text-sm font-medium text-slate-700">Current Password:</label>
                    <input type="password" id="currentPasswordInput" class="mt-1 w-full p-2 border border-slate-300 rounded-lg">
                </div>
                <div>
                    <label for="newPasswordInput" class="block text-sm font-medium text-slate-700">New Password:</label>
                    <input type="password" id="newPasswordInput" class="mt-1 w-full p-2 border border-slate-300 rounded-lg">
                </div>
                <div>
                    <label for="confirmPasswordInput" class="block text-sm font-medium text-slate-700">Confirm New Password:</label>
                    <input type="password" id="confirmPasswordInput" class="mt-1 w-full p-2 border border-slate-300 rounded-lg">
                </div>
            </div>
            <p id="passwordChangeError" class="text-red-500 text-sm mt-2 hidden"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancelPasswordChangeBtn" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200">Cancel</button>
                <button id="savePasswordChangeBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Save Changes</button>
            </div>
        </div>
    </div>
    
    <div id="confirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Are you sure?</h3>
            <p id="confirmMessage" class="text-slate-600 mb-6"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="confirmCancelBtn" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200">Cancel</button>
                <button id="confirmOkBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "dummy", authDomain: "dummy.firebaseapp.com", projectId: "dummy" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'chipmate-attendance-default';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db;
        let isUserAdmin = false;
        let adminPassword = "";
        let listenersAttached = false;

        const students = [
            { id: 7, name: "Arpit Kumar" }, { id: 10, name: "Bichitra Sharma" },
            { id: 11, name: "CHOUDHARY RAKESH RATANARM" }, { id: 18, name: "Harshit" },
            { id: 21, name: "Kavin.K.K" }, { id: 23, name: "Krishna Patel" },
            { id: 26, name: "Manojit Das" }, { id: 32, name: "OM" },
            { id: 35, name: "Priyanshu Raj" }, { id: 37, name: "Rahul Singh" },
            { id: 38, name: "Rohit Sharma" }, { id: 39, name: "Rudra Pratap Singh" },
            { id: 47, name: "Srushti Tanna" }, { id: 56, name: "Vishal Mahatha" },
            { id: 58, name: "Vishvjeet" }
        ].sort((a, b) => a.name.localeCompare(b.name));
        
        let attendanceData = {};

        // DOM Elements
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        const loginBtn = document.getElementById('loginBtn');
        const adminControls = document.getElementById('adminControls');
        const loginModal = document.getElementById('loginModal');
        const dateModal = document.getElementById('dateModal');
        const passwordChangeModal = document.getElementById('passwordChangeModal');
        const confirmModal = document.getElementById('confirmModal');

        // --- Firestore Document References ---
        const getCredentialsRef = () => doc(db, "artifacts", appId, "public/data/club/credentials");
        const getAttendanceRef = () => doc(db, "artifacts", appId, "public/data/club/attendance");

        // --- Firebase & Data Logic ---
        async function startApp() {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            renderTable(); // Initial render with no data

            onAuthStateChanged(auth, user => {
                if (user) {
                    // This is the critical fix: only attach listeners and load data AFTER auth is confirmed.
                    if (!listenersAttached) {
                        attachEventListeners();
                        listenersAttached = true;
                    }
                    loadCredentialsAndData();
                } else {
                    if (initialAuthToken) {
                        signInWithCustomToken(auth, initialAuthToken).catch(e => console.error("Custom token sign-in failed:", e));
                    } else {
                        signInAnonymously(auth).catch(e => console.error("Anonymous sign-in failed:", e));
                    }
                }
            });
        }

        async function loadCredentialsAndData() {
            const credRef = getCredentialsRef();
            const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Database connection timed out")), 10000));
            
            try {
                const credSnap = await Promise.race([getDoc(credRef), timeoutPromise]);
                if (credSnap.exists()) {
                    adminPassword = credSnap.data().password;
                } else {
                    adminPassword = 'chipmateadmin';
                    await setDoc(credRef, { password: adminPassword });
                }
                loginBtn.disabled = false;
                loginBtn.textContent = "Admin Login";
            } catch (error) {
                console.error("Error loading credentials:", error);
                loginBtn.textContent = "Login Failed";
                loginBtn.title = error.message;
            }
            loadAttendanceData();
        }

        function loadAttendanceData() {
            const docRef = getAttendanceRef();
            onSnapshot(docRef, (docSnap) => {
                attendanceData = docSnap.exists() ? docSnap.data().records || {} : {};
                renderTable();
            }, (error) => {
                console.error("Error fetching attendance data:", error);
            });
        }

        async function saveAttendanceData() {
            if (!isUserAdmin) return;
            const docRef = getAttendanceRef();
            await setDoc(docRef, { records: attendanceData }, { merge: true });
        }

        // --- UI Rendering ---
        function setupUI() {
            if (isUserAdmin) {
                adminControls.style.display = 'flex';
                loginBtn.style.display = 'none';
            } else {
                adminControls.style.display = 'none';
                loginBtn.style.display = 'block';
            }
            renderTable();
        }

        function renderTable() {
            const dates = Object.keys(attendanceData).sort();
            tableHeader.innerHTML = `
                <tr>
                    <th class="sticky left-0 bg-slate-50 z-10 text-left text-sm font-semibold text-slate-900">Sr. No.</th>
                    <th class="sticky left-12 bg-slate-50 z-10 text-left text-sm font-semibold text-slate-900">Name</th>
                    <th class="text-left text-sm font-semibold text-slate-900">Enrollment No.</th>
                    ${dates.map(date => `
                        <th class="text-center text-sm font-semibold text-slate-900">
                            <div class="flex items-center justify-center">
                                ${formatDate(date)}
                                ${isUserAdmin ? `<button class="delete-date-btn" data-date="${date}">üóëÔ∏è</button>` : ''}
                            </div>
                        </th>`).join('')}
                    <th class="text-center text-sm font-semibold text-slate-900">Total Present</th>
                </tr>`;

            tableBody.innerHTML = students.map((student, index) => {
                let presentCount = dates.filter(date => attendanceData[date]?.[student.id] === 'P').length;
                return `
                    <tr class="even:bg-white odd:bg-slate-50">
                        <td class="sticky left-0 z-10" style="background-color: inherit;">${index + 1}</td>
                        <td class="sticky left-12 z-10" style="background-color: inherit;">${student.name}</td>
                        <td class="text-slate-500">${student.id}</td>
                        ${dates.map(date => `
                            <td class="text-center"><div class="flex justify-center">${renderStatusButton(date, student.id)}</div></td>
                        `).join('')}
                        <td class="text-center font-semibold text-indigo-600">${presentCount} / ${dates.length}</td>
                    </tr>`;
            }).join('');
        }
        
        function renderStatusButton(date, studentId) {
            const status = attendanceData[date]?.[studentId] || null;
            let sClass = 'status-empty', sText = '-';
            if (status === 'P') { sClass = 'status-p'; sText = 'P'; } 
            else if (status === 'A') { sClass = 'status-a'; sText = 'A'; }
            const editableClass = isUserAdmin ? 'editable' : '';
            return `<div class="status-btn ${sClass} ${editableClass}" data-date="${date}" data-student-id="${studentId}">${sText}</div>`;
        }
        
        // --- Event Handling ---
        function attachEventListeners() {
            // Main control buttons
            loginBtn.addEventListener('click', () => loginModal.classList.remove('hidden'));
            document.getElementById('logoutBtn').addEventListener('click', () => {
                isUserAdmin = false;
                setupUI();
            });
            document.getElementById('addDateBtn').addEventListener('click', () => dateModal.classList.remove('hidden'));
            document.getElementById('downloadBtn').addEventListener('click', handleDownload);
            document.getElementById('changePasswordBtn').addEventListener('click', () => passwordChangeModal.classList.remove('hidden'));

            // Modal buttons
            document.getElementById('cancelLoginBtn').addEventListener('click', () => loginModal.classList.add('hidden'));
            document.getElementById('submitLoginBtn').addEventListener('click', handleLogin);
            document.getElementById('cancelDateBtn').addEventListener('click', () => dateModal.classList.add('hidden'));
            document.getElementById('saveDateBtn').addEventListener('click', handleSaveDate);
            document.getElementById('cancelPasswordChangeBtn').addEventListener('click', () => passwordChangeModal.classList.add('hidden'));
            document.getElementById('savePasswordChangeBtn').addEventListener('click', handleSavePassword);
            
            // Confirmation Modal Buttons
            document.getElementById('confirmCancelBtn').addEventListener('click', () => confirmModal.classList.add('hidden'));
            document.getElementById('confirmOkBtn').addEventListener('click', (e) => {
                const dateToDelete = e.currentTarget.dataset.date;
                if (dateToDelete) {
                    delete attendanceData[dateToDelete];
                    saveAttendanceData();
                }
                confirmModal.classList.add('hidden');
            });

            // Table actions (event delegation on the whole table)
            tableWrapper.addEventListener('click', (e) => {
                if (!isUserAdmin) return;
                const statusBtn = e.target.closest('.status-btn.editable');
                const deleteBtn = e.target.closest('.delete-date-btn');

                if (statusBtn) {
                    handleStatusClick(statusBtn);
                }
                if (deleteBtn) {
                    handleDeleteDateClick(deleteBtn);
                }
            });
        }

        function handleStatusClick(button) {
            const { date, studentId } = button.dataset;
            const currentStatus = attendanceData[date]?.[studentId] || null;
            let nextStatus = 'P';
            if (currentStatus === 'P') nextStatus = 'A';
            else if (currentStatus === 'A') nextStatus = null;
            if (!attendanceData[date]) attendanceData[date] = {};
            if (nextStatus === null) delete attendanceData[date][studentId];
            else attendanceData[date][studentId] = nextStatus;
            
            saveAttendanceData();
        }

        function handleDeleteDateClick(button) {
            const dateToDelete = button.dataset.date;
            document.getElementById('confirmMessage').textContent = `Are you sure you want to delete the column for ${formatDate(dateToDelete)}? This action cannot be undone.`;
            document.getElementById('confirmOkBtn').dataset.date = dateToDelete;
            confirmModal.classList.remove('hidden');
        }

        function handleLogin() {
            const passwordInput = document.getElementById('passwordInput');
            const loginError = document.getElementById('loginError');
            if (passwordInput.value === adminPassword) {
                isUserAdmin = true;
                loginModal.classList.add('hidden');
                passwordInput.value = '';
                loginError.classList.add('hidden');
                setupUI();
            } else {
                loginError.classList.remove('hidden');
            }
        }

        function handleSaveDate() {
            const dateValue = document.getElementById('dateInput').value;
            if (dateValue) {
                if (!attendanceData[dateValue]) {
                    attendanceData[dateValue] = {};
                    saveAttendanceData();
                } else {
                    const msgBox = document.createElement('div');
                    msgBox.textContent = 'This date already exists.';
                    msgBox.className = 'fixed top-5 right-5 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg';
                    document.body.appendChild(msgBox);
                    setTimeout(() => msgBox.remove(), 3000);
                }
                dateModal.classList.add('hidden');
            }
        }

        async function handleSavePassword() {
            const currentPasswordInput = document.getElementById('currentPasswordInput');
            const newPasswordInput = document.getElementById('newPasswordInput');
            const confirmPasswordInput = document.getElementById('confirmPasswordInput');
            const errorMsg = document.getElementById('passwordChangeError');

            errorMsg.classList.add('hidden');

            if (currentPasswordInput.value !== adminPassword) {
                errorMsg.textContent = "Current password is not correct.";
                errorMsg.classList.remove('hidden');
                return;
            }
            if (!newPasswordInput.value || newPasswordInput.value !== confirmPasswordInput.value) {
                errorMsg.textContent = "New passwords do not match or are empty.";
                errorMsg.classList.remove('hidden');
                return;
            }

            const newPassword = newPasswordInput.value;
            const credRef = getCredentialsRef();
            try {
                await setDoc(credRef, { password: newPassword });
                adminPassword = newPassword;
                alert("Password changed successfully!");
                passwordChangeModal.classList.add('hidden');
                currentPasswordInput.value = '';
                newPasswordInput.value = '';
                confirmPasswordInput.value = '';
            } catch (e) {
                errorMsg.textContent = "Failed to save new password. Please try again.";
                errorMsg.classList.remove('hidden');
                console.error("Password change error:", e);
            }
        }
        
        function handleDownload() {
            const dates = Object.keys(attendanceData).sort();
            let csvContent = "data:text/csv;charset=utf-8,";
            const header = ["Sr. No.", "Name", "Enrollment No.", ...dates.map(d => formatDate(d))];
            csvContent += header.join(",") + "\r\n";
            students.forEach((student, index) => {
                const row = [
                    index + 1, `"${student.name}"`, student.id,
                    ...dates.map(date => attendanceData[date]?.[student.id] || '')
                ];
                csvContent += row.join(",") + "\r\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "ChipMate_Attendance.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function formatDate(d) { return `${d.slice(8,10)}/${d.slice(5,7)}/${d.slice(2,4)}`; }
        
        // --- Initial Load ---
        startApp();
    </script>
</body>
</html>
